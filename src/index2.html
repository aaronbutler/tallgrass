<!doctype html>
<html lang="en" data-framework="knockoutjs">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Promise Map</title>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="http://maps.googleapis.com/maps/api/js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>
	<script src="js/MarsUtils.js"></script>
	<script src="js/util.js"></script>
	<script>
		var log = new Log(2);
	</script>
	<style>
		html, body {
			width: 100%;
			height: 100%;
		}		
		
		body {
			//overflow-y: hidden;
		}
		
		header {
			height: 10%;
		}
		
		#MapSearchSection {
			height: 90%;
		}
		
		.searchPanel {
			height: 20%;
			display: flex;
			flex-wrap: wrap;
		}
		
		.searchQuery {
			width: 20%;
		}
		
		.searchInstructions {
			width: 77%;
		}
		
		.markerSection  {
			position: absolute;
			width: 22%;
			//margin-top: 10%;
		}
		.markerList{
			width: 100%;
			border-style:solid;
			border-width: 2px;
			
			display: flex;
			flex-wrap: wrap;
			flex-direction: column;
			z-index: 10;
		}
		
		.markerTitles {
			font: bold 1.4em arial, sans-serif;
			color: blue;
		}
		
		.map {
			width: 75%;
			height: 80%;
			margin-left: 22%;
			-webkit-transition-duration: 6000ms;
			transition-duration: 6000ms;
		}
		
		.cover {
			width: 100%;
			height: 100%;
		}
		
		.cover {
			-webkit-transition-duration: 6000ms;
			transition-duration: 6000ms;
			position: absolute;
			//margin-top: 10%;
			top: 10%;
			width: 87%;
			left: 50%;
			margin: 0 0 0 -43.5%;
			background-color: red;
			box-shadow: -15px -15px 53px #888888;
			opacity: 1;
			z-index: 1000;
		}
		
		.cover.hide {
			opacity: 0.5;
			transform: translateY(100%);
			-webkit-transform: translateY(100%);
		}
		
		.cover::before {
			height: 10%;
			opacity: 0;
		}
		
		a.closer{
			float:right;
			margin-top:5px;
			margin-right:5px;
			cursor:pointer;
			color: #fff;
			border: 1px solid #AEAEAE;
			border-radius: 30px;
			background: #605F61;
			font-size: 31px;
			font-weight: bold;
			display: inline-block;
			line-height: 0px;
			padding: 11px 3px;       
		}

		
		.closer:before {
			content: "X";
		}
		

	</style>
</head>
<body>

	<header>
		<h1>The Tall Grass of Mars</h1>
		<div>What happened when I set out to make an interesting Mars/Google Maps app and settled for placing the Curiosity rover in Papua and using defunct APIs in my mashup.</div>
	</header>
	
	<section id="MapSearchSection">
		<div id="searchPanel" class="searchPanel mapScreen">
			<input id="searchQuery" class="searchQuery" placeholder="Search"></input>
			<div id="searchInstructions" class="searchInstructions">Search for Quadrants, or for Sols using sol:sol#</div>
		</div>
		<div id="markerSection" class="markerSection mapScreen">
			<div id="markerList" class="markerList">
				<div class="markerTitles"></div>
			</div>
		</div>
	
		<div id="map" class="map"></div>
	</section>
	<div class="cover">
		<a class="closer"></a>
	</div>
	<script>
	
		$(document).ready(function () {
			viewModel = new MarsViewModel();
			ko.applyBindings(viewModel);
			
			$('.closer').click(function(){
				$('.cover').addClass('hide');
			});
		});

		function MarsViewModel() {
			var self = this;
			
			//Models////////////////////////////////
			self.appModel = new Object();
			self.mapModel = new Object();
			self.solModel = new Object();
			
			//appModel
			var d = new Date();
			d.setFullYear(2012, 7, 6);
			self.appModel.solendar = new Solendar(0,d);
			self.appModel.sols = [];
			
			self.appModel.searchQuery = ko.observable();
			self.appModel.solNumber = ko.observable();
			
			
			//mapModel
			self.mapModel.map = '';
			self.mapModel.points = [];
			self.mapModel.line = '';
			self.mapModel.subPoints = [];
			self.mapModel.subLine = '';
			self.mapModel.landmarks = [];
			
			self.mapModel.activeLandmarks = ko.observableArray();
			
			
			//solModel
			self.solModel.currentPicArray = ko.observableArray();
			self.solModel.currentPicData = ko.observable();
			self.solModel.currentWeatherData = ko.observable();
			
			//Behaviors//////////////////////////////
			
			
			//Initializers///////////////////////////
			var locationPromise = getLocations();
			var mapPromise = buildMap();
			Promise.all([locationPromise, mapPromise]).then(function(arrayOfResults){
				self.appModel.sols = arrayOfResults[0];
				self.mapModel.map = arrayOfResults[1];
				
				self.mapModel.points = makePointsArray(self.appModel.sols);
				self.mapModel.line = buildPath(self.mapModel.map, self.mapModel.points);
				$('#map').removeClass('hide');
				//resolve('Woo hoo!');
			});
			
			self.mapModel.landmarks = initLandmarks();
			mapPromise.then(function(response){
				var ONAME = 'MarsViewModel';
				var FNAME = 'anomymous mapPromise.then';
				log.log(3,ONAME,FNAME,'directly calling then seperate from Promise.all',this);
				self.mapModel.landmarks.forEach(function(landmark,i){
					self.mapModel.activeLandmarks.push(addLandmark(response,landmark));
				});
			});
		};
	
		function getLocations() {
			
			var ONAME =  'Global';
			var FNAME = 'getLocations';
			log.log(3,ONAME,FNAME,'entering getLocations',this);
			return new Promise(function(resolve,reject){
				var worker = new Worker('js/locationWorker.js');
				worker.postMessage({});
				worker.onmessage = function(e) {
					var sols = e.data;
					worker.terminate();
					resolve(sols);
				};
			});
		};
		
		function buildMap() {
			var ONAME =  'Global';
			var FNAME = 'buildMap';
			log.log(3,ONAME,FNAME,'entering buildMap',this);
			return new Promise(function(resolve,reject){
			
				var mq = window.matchMedia( "(max-width: 768px)" );
				var z=mq.matches?11:13;
				var latLng = new google.maps.LatLng(-4.63,137.395)
				var mapOptions = { center: latLng,
					zoom: z,
					mapTypeControl:false	
				};

				var el = document.getElementById('map');
				var map = new google.maps.Map(el, mapOptions);
				map.cent = latLng;
				
				var quadLayer = new google.maps.KmlLayer({
					//url: 'http://aaronbutler.github.io/kmls/quadrants.kml',
					//url: 'http://aaronbutler.github.io/marsmap/kml/quadrants.kml',
					url: 'http://aaronbutler.github.io/tallgrass/src/data/quadrants.kml',
					preserveViewport:true,
					map: map
				});
				resolve(map);
			
			
			});
		};
		
		
		
		//Take every lat/long point on the sols and put them in an ordered array, and return
		function makePointsArray(sols) {
			var solArray = sols.sols;
			var pointArray = [];
			for(var i=0,l=solArray.length;i<l;i++) {
				var locArray = solArray[i].locations;
				for(j=0,e = locArray.length;j<e;j++) {
					var lat = parseFloat(locArray[j].lat);
					var lon = parseFloat(locArray[j].lon);
					pointArray.push({lat: lat, lng: lon});
				}
			}
			return pointArray;
		};

		// Create the polyline and add the symbol to it via the 'icons' property.
		var buildPath = function(map, points) {
			var lineSymbol = {
				path: google.maps.SymbolPath.CIRCLE,
				scale: 8,
				strokeColor: '#393'
			};
			var _p = points instanceof Function ? points() : points;
			var line = new google.maps.Polyline({
				path: _p,
				icons: [{
					icon: lineSymbol,
					offset: '0%'
				}],
				map: map
			});
			return line;
		};
		
		function initLandmarks() {
			var ONAME = 'global';
			var FNAME = 'initLandmarks';
			log.log(1,ONAME,FNAME,'Entering initLandmarks');
			
			var landmarks = [];
			landmarks.push(new Landmark('Yellowknife Bay Quadrant','https://en.wikipedia.org/wiki/Yellowknife_Bay,_Mars',"Yellowknife Bay is a geologic formation in Gale Crater on the planet Mars. NASA's Mars Science Laboratory Rover, named Curiosity, arrived at the low lying depression on December 17, 2012, 125 sols, or martian days, into its 668 sol planned mission on the planet. Primary mission goals of the Mars Science Laboratory were to assess the potential habitability of the planet and whether or not the Martian environment is, or has ever been, capable of supporting life. The site was chosen after much study of the region by previous missions. The Mars Reconnaissance Orbiter observed morphological features created by the presence of liquid water, suggesting the presence of an ancient lake which could have sustained microbial life. The geologic depression takes its name from the city Yellowknife, capital of the Canadian Northwest Territories, in honor of the 4 billion year old rock in the region surrounding the city, which matches the approximate age of the uncovered rock in Gale Crater.",137.445,-4.58));
			
			landmarks.push(new Landmark('Mawson Quadrant','?','Martian rollover quadrant? Not much seemed to happen here.',137.445,-4.605));
			
			landmarks.push(new Landmark('Coeymans Quadrant','?','Martian rollover quadrant? Not much seemed to happen here.',137.42,-4.605));
			
			landmarks.push(new Landmark('Kimberley Quadrant','http://www.jpl.nasa.gov/news/news.php?feature=4100','On Wednesday, NASAs Curiosity Mars rover drove the last 98 feet feet (30 meters) needed to arrive at a site planned since early 2013 as a destination for studying rock clues about ancient environments that may have been favorable for life.The rover reached a vantage point for its cameras to survey four different types of rock intersecting in an area called "the Kimberley," after a region of western Australia."This is the spot on the map weve been headed for, on a little rise that gives us a great view for context imaging of the outcrops at the Kimberley," said Melissa Rice of the California Institute of Technology, Pasadena. Rice is the science planning lead for what are expected to be several weeks of observations, sample-drilling and onboard laboratory analysis of the areas rocks.',137.42,-4.63));
			
			landmarks.push(new Landmark('Hanover Quadrant','http://mars.jpl.nasa.gov/msl/multimedia/images/?ImageID=6354','This map shows in red the route driven by NASAs Curiosity Mars rover from the "Bradbury Landing" location where it touched down in August 2012 (blue star at upper right) through the 663rd Martian day, or sol, of the rovers work on Mars (June 18, 2014). The white line shows the planned route ahead to reach "Murray Buttes" (at white star), the chosen access point to destinations on Mount Sharp. The rover will complete a mission goal of working for a full Martian year on Sol 669 (June 24, 2014). A Martian year is 687 Earth days. Gridlines indicate quadrants charted before the rovers landing for purposes of geological mapping of the landing region within Mars Gale Crater. The Sol 663 location is within the Hanover quadrant. Next on the rovers route is the Shoshone quadrant.',137.395,-4.63 ));
			
			landmarks.push(new Landmark('Shoshone Quadrant','http://astrogeology.usgs.gov/news/astrogeology/sol-671-update-on-curiosity-from-usgs-scientist-ryan-anderson-long-drive',' After a 107 m drive on sol 670, we are now in Shoshone quad, and just 160 m from the edge of the landing ellipse! The sol 671 plan is a lot like the sol 670 plan, with a 3 hour drive as the main activity. These long drives often use visual odometry, where the rover takes pictures along the way to monitor how the drive is going and avoid obstacles. This is a great capability, allowing us to drive farther than we could otherwise, but a side effect is that it produces a lot of data. The result: less data available for science observations.All of which is to say that today was another data-constrained sol. There’s always a way to squeeze some science in though! Today’s plan has a color stereo image of a rock dubbed Lost Burro, a ChemCam passive observation of the sky, and a NavCam movie of the sky looking for clouds. (Passive means that we don’t fire the laser, we just passively collect the spectrum of the target.) We also managed to squeeze a ChemCam measurement of our titanium calibration target and a MAHLI end-of-drive stowed image between the orbiter communication passes. And of course, we always do routine environmental monitoring with RAD, REMS, and DAN. Plus, after each drive we take clast survey images of the ground with Mastcam. Not bad for a data-constrained sol! ',137.395,-4.655));
			
			landmarks.push(new Landmark('Arlee Quadrant','http://missoulian.com/news/local/nasa-comes-to-arlee-the-martian-one/article_382792c8-19fd-5320-b1ad-2769c8b5fa53.html','The Mars rover Curiosity was rolling through Arlee on Friday. Not that Arlee. The one on Mars.“Because western Montana is interesting geologically, it ranked up there to get on the names list,” said Brian Nixon, who operates the Rover’s cameras for Malin Space Science Systems in San Diego. “Those are the formal names we use among team members to reference certain features. "A little while ago, the rover was going up something we called Logan Pass. That turned out to be too difficult to drive up, so I suggested the next gap over, which we called Marias Pass. If you’re going through Glacier (National Park) and you can’t make it up, you go south and go through the year-round pass.”',137.37,-4.655));
			
			landmarks.push(new Landmark('Windhoek Quadrant','http://www.az.com.na/lokales/windhoek-quadrat-auf-dem-mars.425665','Der jahrelange Leiter der Wissenschaftlergruppe, die mit dem Fahrzeug Curiosity den Mars erforscht, weilte wieder einmal in Namibia und findet die Naukluft ebenso interessant wie den Roten Planeten. Bald soll sich das sechsrädrige Forschungslabor in ein Quadrat mit namibischem Namen begeben. Dr. John Grotzinger hielt in Windhoek einen Vortrag und ist Empfänger der Henno-Martin-Medaille.',137.37,-4.68));
			
			landmarks.push(new Landmark('Bar Harbour Quadrant','Captain Jean-Luc Picard','Five card stud, nothing wild, and the sky is the limit.',137.345,-4.68));
			
			
			return landmarks;
		};
		
		function addLandmark(map, landmark) {
			var latlng = new google.maps.LatLng(landmark.lat,landmark.lng);
			var marker = new google.maps.Marker({
				position: latlng,
				title:landmark.name,
				showme: ko.observable(true),
				clicker: function() {
					this.setAnimation(google.maps.Animation.DROP);
					this.infowindow.open(this.map, this);
				}
			});
			var contentString = '<h2>'+landmark.name+'</h2><p>'+landmark.description+'</p>';
			var infowindow = new google.maps.InfoWindow({content: contentString});
			//var infowindow = new InfoBubble({minWidth: '400px', maxWidth: '400px'});
			//infowindow.addTab('TAB',contentString);
			marker.infowindow = infowindow;
			marker.map = map;
			google.maps.event.addListener(infowindow, 'closeclick', function() {
				map.setCenter(map.cent);
				infowindow.close();
			});
			
			marker.addListener('click', function(){
				marker.setAnimation(google.maps.Animation.DROP);
				infowindow.open(map,marker);
			});
			
			marker.setMap(map);

			return marker;
		};
	</script>
</body>
</html>
